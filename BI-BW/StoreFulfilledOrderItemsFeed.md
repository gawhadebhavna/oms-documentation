## Store Fulfilled Order Items Feed From HotWax to BI/BW

A representative sample of the CSV structure used to store fulfilled order item data appears below:

|Order Date| Order Number |Item Number|Material ID|EAN/UPC|Qty|MSRP|Sold Price|Tax|Freight|Customer Paid|Smaregi Store No|Tender Type|
|----------|--------------|----------|------------|-------|---|----|----------|----|------|----------|------------|------------|
|20200627| SMUS#4710    |1||829105016101|1|49.99|49.99|30|0|119.99|2|Shopify Payment|
|20200627| SMUS#4711    |2||824095530101|1|114.99|114.99|0|0|114.99|9|Shopify Payment|

### Requirement

Streamline the process of transferring fulfilled order items from HotWax to BI/BW by introducing an automated system for generating the Store Fulfilled Order Items Feed. 
This feed should only contain the order items that are fulfilled from stores instead of warehouses.

### Design and Decisions
1. The Store Fulfilled Order Items Feed for BI/BW should not include those order items that are fulfilled from warehouses.
2. The shipping charges will be sent with the first item of each order, subsequent items will have a shipping charges as zero.
3. For orders containing a mix of store and warehouse fulfilled order items, no shipping charges will be sent for any item of the order.

### Implementation Flow

1. Moqui:
   1. A scheduled service job will automatically fetch eligible records and prepare the JSON file format of Fulfilled Order Items Feed.
   2. This initial feed will include all order items, whether the order items fulfilled from stores or warehouses.
   3. The prepared file of Fulfilled Order Items feed will be kept on the SFTP location.
   
2. NiFi:
   1. NiFi will read the Fulfilled Order Items Feed file generated by Moqui from the SFTP location, will apply the required transformations 
      and exclude those order items that are fulfilled from warehouses. 
   2. In the further process NiFi will convert the data from JSON format to CSV format and keep the file on the SFTP location for BI/BW consumption.
   
### NiFi Flow
1. This NiFi flow automates the handling to prepare and send the Store Fulfilled Order Items Feed from HotWax to BI/BW. 
   It utilizes a sequence of processors to seamlessly manage data preparation and conversions for the Store Fulfilled Order Items Feed.
    1. **ListSFTP**
        1. The ListSFTP processor is configured to read and process the Moqui generated Fulfilled Order Items JSON feed file from the SFTP location.

    2. **FetchSFTP**
       1. The FetchSFTP processor will move the Moqui generated Fulfilled Order Items Feed file into the archive folder, this needed to manage the files that are processed by NiFi.

    3. **JoltTransformJSON**
        1. The JoltTransformJSON processor is used to transform the HC generated Fulfilled Order Items feed JSON into the
           required JSON format of Store Fulfilled Order Items Feed.

    4. **ConvertRecord**
        1. The ConvertRecord processor is used to convert the Store Fulfilled Order Items Feed file format into the CSV file format.

    5. **UpdateAttribute**
        1. The UpdateAttribute processor is used to update the file name of Store Fulfilled Order Items Feed CSV file format.

    6. **PutSFTP**
        1. The PutSFTP processor is used to put the Store Fulfilled Order Items Feed CSV file at the SFTP.

### Mapping of the Fulfilled Order Items Feed for BI/BW File format

| Field Name | Type   | Description | HC Fulfilled Order Items Feed Mapping |
|---------|--------|-------------|----------|
| Order Date | string | The date when the order is placed. | orderDate |
| Order Number | string | The name of the order in the system. | orderName|
| Item Number | string | The item Seq ID assigned to an item of an order in the system. | orderItemSeqId |
| Material ID | string | The material ID assigned to an order item in the system. | The empty value will be sent in the field Material ID. |
| EAN/UPC | string | The product identification value in the system. | shipments[n].shipmentItems[n].goodIdentifications[n].idValue |
| Qty | number | The quantity of an order item in the system. | shipments[n].shipmentItems[n].shippedQuantity |
| MSRP | number | The unit price of an order item in the system. | shipments[n].shipmentItems[n].unitPrice |
| Sold Price | number | The discounted price of the order item. | shipments[n].shipmentItems[n].orderItemAdjustments[n].amount  <br/>**NOTE:** <br/> 1. orderAdjustmentTypeId should be EXT_PROMO_ADJUSTMENT <br/> 2. Discounted Price is populated ((unitPrice of an order item * quantity of an order item) - sum of all the discounts applied on the order item). |
| Tax | number | The sales tax of the order item in the system. | shipments[n].shipmentItems[n].orderItemAdjustments[n].amount <br/> **NOTE:** <br/> 1. orderAdjustmentTypeId should be SALES_TAX |
| Freight | number | The shipping charges inclusive of shipping tax and shipping adjustments of an order in the system. | orderItemAdjustments[n].amount <br/> **NOTE:** <br/> 1. orderAdjustmentTypeId should be SHIPPING_CHARGES and/or EXT_SHIP_ADJUSTMENT and/or SHIPPING_SALES_TAX |
| Customer Paid | number | The amount that is paid by the customer to buy the order item. | The value for the Customer Paid is populated by the sum of (Sold Price +  Tax +  Freight) |
| Smaregi Store No | string | The store number assigned to the product in the system. | shipments[n].shipmentItems[n].facilityExternalId |
| Tender Type | string | The payment method type that is used to pay for the order item. | paymentMethodCode <br/> **NOTE:**  <br/> 1. If the paymentMethodCode is null then will sent the paymentMethodDescription |

### Custom Transformations for Store Fulfilled Order Items Feed BI/BW
For seamless consumption by BI/BW, certain fields within the Store Fulfilled Order Items Feed require customized data manipulation.
1. **Order Date**
    - The Order Date field precisely captures the date when the order was initially entered into the system.
    - It should be sent to BI/BW in the required format of date that is 'YYYY/MM/DD'.

2. **Item Number**
    - In the Moqui generated Fulfilled Order Items Feed there is a field called orderItemSeqId,
      which is used to prepare the value of Item Field for Store Fulfilled Order Items Feed BI/BW.
    - In Moqui generated feed, the value of the orderItemSeqId has the leading zeros, and that is need to remove as per the requirement of BI/BW.
    - To make it possible, converted the type of orderItemSeqId using the function **toLong** in the transformation.

3. **Sold Price**
    - The Sold Price is corresponds to the final price of an item after applying all discounts.
    - Calculation: [(unitPrice of an order item * quantity of an order item) - sum of all the discounts applied to the order item].

4. **Tax**
    - The Tax field Represents the sales tax amount for each order item, calculated from orderItemAdjustments[n].amount and filtered for orderAdjustments[n].orderAdjustmentTypeId = SALES_TAX.

5. **Freight**
    - For each order, the Freight field represents the final amount paid for delivering the items, including any taxes or additional charges applied to the shipping process.
    - This is calculated using orderAdjustments[n].amount, orderAdjustments[n].orderAdjustmentTypeId should be **SHIPPING_CHARGES** and/or **EXT_SHIP_ADJUSTMENT** and/or **SHIPPING_SALES_TAX**.

6. **Customer Paid**
    - The Customer Paid represents the final amount paid by the customer for each order item.
    - Customer Paid is populated by (Sold Price +  Tax +  Freight).